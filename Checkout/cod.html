<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secure Checkout (COD) - Hammer of Night Rider</title>
  <link rel="stylesheet" href="../css/theme-overrides.css" />
  <link rel="stylesheet" href="../css/checkout-ui.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <header class="brand">
        <div class="title">HAMMER OF <span class="brand-accent">NIGHT RIDER</span> • Secure Checkout</div>
        <div class="cod">Cash on Delivery</div>
        <button class="btn" id="themeToggle" type="button">Light mode</button>
      </header>
      <div class="content">
        <form id="codForm" onsubmit="return false;">
          <div class="section">
            <h2>Contact</h2>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" autocomplete="email" required />
            <label for="phone">Phone (for delivery confirmation)</label>
            <input id="phone" name="phone" type="tel" autocomplete="tel" required />
            <p class="help">We'll only use your phone to coordinate the delivery.</p>
          </div>

          <div class="section" style="margin-top:14px;">
            <h2>Shipping address</h2>
            <div class="grid-2">
              <div>
                <label for="firstName">First name</label>
                <input id="firstName" name="firstName" autocomplete="given-name" required />
              </div>
              <div>
                <label for="lastName">Last name</label>
                <input id="lastName" name="lastName" autocomplete="family-name" required />
              </div>
            </div>
            <label for="address">Address</label>
            <input id="address" name="address" autocomplete="address-line1" required />
            <div class="grid-2">
              <div>
                <label for="city">City</label>
                <input id="city" name="city" autocomplete="address-level2" required />
              </div>
              <div>
                <label for="zip">ZIP / Postal code</label>
                <input id="zip" name="zip" autocomplete="postal-code" required />
              </div>
            </div>
            <label for="notes">Delivery notes (optional)</label>
            <textarea id="notes" name="notes" rows="3" placeholder="e.g. Gate code, preferred time window"></textarea>
          </div>

          <div class="section" style="margin-top:14px;">
            <h2>Payment</h2>
            <div class="inline">
              <input type="radio" id="cod" name="payment" checked />
              <label for="cod" style="margin:0;">Cash on Delivery <span class="help">(Pay when you receive your package)</span></label>
            </div>
            <div class="actions">
              <button id="placeOrder" class="btn btn-primary" type="submit">Place COD Order</button>
              <div class="help">By placing your order you agree to our Terms and Privacy Policy.</div>
            </div>
          </div>
        </form>

        <aside>
          <div class="section summary">
            <div class="item">
              <img id="sumImage" src="" alt="Product" />
              <div>
                <div id="sumName" class="name">Selected Package</div>
                <div id="sumSku" class="sku">—</div>
              </div>
              <div style="margin-left:auto" id="sumPrice" class="price">$0.00</div>
            </div>
            <hr class="hr" />
            <div class="totals">
              <div class="line"><span class="muted">Subtotal</span><span id="subTotal">$0.00</span></div>
              <div class="line"><span class="muted">Shipping</span><span id="ship">FREE</span></div>
              <div class="line"><span class="muted">Payment</span><span>Cash on Delivery</span></div>
              <div class="line total"><span>Total</span><span id="grandTotal">$0.00</span></div>
            </div>
          </div>
          <div class="section" style="margin-top:14px;">
            <div class="help">60-day guarantee. Questions? Contact Support.</div>
          </div>
        </aside>
      </div>
    </div>
    <footer>© <span id="year"></span> Hammer of Night Rider</footer>
  </div>

  <script src="../js/theme-toggle.js"></script>
  <script src="../js/currency.js"></script>
  <script>
    (async function(){
      const $ = (s)=>document.querySelector(s);
      const params = new URLSearchParams(location.search);
      const sku = (params.get('sku')||'').toUpperCase();

      // Load plans and currency (prices already in selected currency)
      let CUR = { code:'USD', symbol:'$', rate:1 };
      let plan = null;
      try {
        const apiUrl = (location.origin||'') + '/admin/api/plans.php?t=' + Date.now();
        const res = await fetch(apiUrl, { credentials: 'same-origin', cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          if (data && data.ok) {
            CUR = data.currency || CUR;
            const bySku = {};
            (data.plans||[]).forEach(p => bySku[p.sku] = p);
            if (sku && bySku[sku]) plan = bySku[sku];
          }
        }
      } catch(e){}

      const fmt = (n)=>{ try{ return (CUR.symbol||'$') + new Intl.NumberFormat(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}).format(+n||0) }catch(e){ return (CUR.symbol||'$')+Number(n||0).toFixed(2);} };

      const urlPrice = parseFloat(params.get('price')||'0');
      const price = plan && plan.total_price ? Number(plan.total_price) : urlPrice;
      const name  = plan && plan.title ? (plan.title + (plan.subtitle ? ' — ' + plan.subtitle : '')) : 'Selected Package';
      const img   = plan && plan.image_main ? (plan.image_main.startsWith('/') ? ('..'+plan.image_main) : plan.image_main) : '../images/img-PRODx3.png';

      // Populate summary
      $('#sumName').textContent = name;
      $('#sumSku').textContent = sku || '—';
      $('#sumImage').src = img;
      $('#sumPrice').textContent = fmt(price);
      $('#subTotal').textContent = fmt(price);
      $('#grandTotal').textContent = fmt(price);
      $('#year').textContent = new Date().getFullYear();

      // Submit handler
      $('#codForm').addEventListener('submit', function(){
        // Minimal client-side validation
        const required = ['email','phone','firstName','lastName','address','city','zip'];
        for (const id of required){ const el = document.getElementById(id); if(!el || !el.value.trim()){ el && el.focus(); return; } }
        const order = {
          payment:'COD', sku, price,
          product: { name, img },
          contact:{ email: $('#email').value, phone: $('#phone').value },
          address:{ line1: $('#address').value, city: $('#city').value, zip: $('#zip').value },
          name: ($('#firstName').value||'')+' '+($('#lastName').value||''),
          notes: ($('#notes') && $('#notes').value) || '',
          createdAt: new Date().toISOString()
        };
        // Attach currency context
        order.currency = { code: CUR.code, symbol: CUR.symbol, rate: CUR.rate };
        const btn = document.getElementById('placeOrder'); if (btn) btn.disabled = true;
        (async () => {
          try {
            const apiUrl = (location.origin ? location.origin : '') + '/admin/api/order-create.php';
            const res = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type':'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ ...order, secret: 'f3b1d8f74a0c9f2b3d1a7baf8c3a6e12c3f4e22e991a9d3b1b7f8e9a6c1d2f4e' })
            });
            if (res.ok) {
              const data = await res.json();
              if (data && data.ok) {
                order.orderNumber = data.order_number || null;
                order.orderId = data.order_id || null;
              } else {
                alert('Order saved locally, but not recorded in admin: ' + (data && data.error ? data.error : 'Unknown error'));
              }
            } else {
              alert('Order saved locally, but admin API responded with HTTP ' + res.status);
            }
          } catch (e) { /* fallback only */ }
          try{ sessionStorage.setItem('lastOrder', JSON.stringify(order)); }catch(e){}
          location.href = 'thank-you.html';
        })();
      });
    })();
  </script>
</body>
</html>
